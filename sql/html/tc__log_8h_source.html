<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.15"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>My Project: tc_log.h Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">My Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.15 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">tc_log.h</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/* Copyright (c) 2015, 2017, Oracle and/or its affiliates. All rights reserved.</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="comment">   This program is free software; you can redistribute it and/or modify</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="comment">   it under the terms of the GNU General Public License as published by</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="comment">   the Free Software Foundation; version 2 of the License.</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="comment">   This program is distributed in the hope that it will be useful,</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="comment">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="comment">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="comment">   GNU General Public License for more details.</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="comment">   You should have received a copy of the GNU General Public License</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="comment">   along with this program; if not, write to the Free Software</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="comment">   Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA 02110-1301  USA */</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#ifndef TC_LOG_H</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#define TC_LOG_H</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;my_global.h&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &quot;my_sys.h&quot;</span>                  <span class="comment">// my_msync</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &quot;mysql/psi/mysql_thread.h&quot;</span>  <span class="comment">// mysql_mutex_t</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="preprocessor">#include &quot;mysqld.h&quot;</span>                  <span class="comment">// LOCK_consistent_snapshot</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;<span class="keyword">class </span><a class="code" href="namespaceTHD.html">THD</a>;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="keyword">typedef</span> ulonglong my_xid;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;<span class="preprocessor">#define TC_LOG_MIN_PAGES   6</span></div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno"><a class="line" href="classTC__LOG.html">   40</a></span>&#160;<span class="keyword">class </span><a class="code" href="classTC__LOG.html">TC_LOG</a></div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;{</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  <span class="keywordtype">bool</span> <a class="code" href="classTC__LOG.html#a57d3ed9dfb015fb2427a25eecaf78687">using_heuristic_recover</a>();</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  <a class="code" href="classTC__LOG.html">TC_LOG</a>() {}</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;  <span class="keyword">virtual</span> ~<a class="code" href="classTC__LOG.html">TC_LOG</a>() {}</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;  <span class="keyword">enum</span> enum_result {</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;    RESULT_SUCCESS,</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;    RESULT_ABORTED,</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    RESULT_INCONSISTENT</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;  };</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTC__LOG.html#a34eb4c35fe8d29b0febbd700a61b282d">open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *opt_name)=0;</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTC__LOG.html#a645b5d1b49c4c4396d327eef07e2dd53">close</a>()=0;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;  <span class="keyword">virtual</span> enum_result <a class="code" href="classTC__LOG.html#a3f9ef43db745a798f8b361eb0b93ff22">commit</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all) = 0;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTC__LOG.html#abf637f1bbf02c6f8e4f69aa2f5e2d362">rollback</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all) = 0;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">int</span> <a class="code" href="classTC__LOG.html#ab968f1e200f370127c3dcd0302d00968">prepare</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all) = 0;</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTC__LOG.html#aac75dc061e9aae27449e675b23c27ae3">xlock</a>(<span class="keywordtype">void</span>) = 0;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTC__LOG.html#a60ee380273adc9e23c56ff114cd2636a">xunlock</a>(<span class="keywordtype">void</span>) = 0;</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTC__LOG.html#a5b73af1ad12c691b3417c565f7e58a1c">slock</a>(<span class="keywordtype">void</span>) = 0;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">void</span> <a class="code" href="classTC__LOG.html#ab383cdb4b722c9b11d284ac8b970b087">sunlock</a>(<span class="keywordtype">void</span>) = 0;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;};</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html">  145</a></span>&#160;<span class="keyword">class </span><a class="code" href="classTC__LOG__DUMMY.html">TC_LOG_DUMMY</a>: <span class="keyword">public</span> <a class="code" href="classTC__LOG.html">TC_LOG</a> <span class="comment">// use it to disable the logging</span></div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;{</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  <a class="code" href="classTC__LOG__DUMMY.html">TC_LOG_DUMMY</a>() {}</div><div class="line"><a name="l00149"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#ac5c9f424a1544aafc9fe08e894bbce81">  149</a></span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__DUMMY.html#ac5c9f424a1544aafc9fe08e894bbce81">open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *opt_name)        { <span class="keywordflow">return</span> 0; }</div><div class="line"><a name="l00150"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#adb7792f21f5a090a7d71a646d2ebf82f">  150</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__DUMMY.html#adb7792f21f5a090a7d71a646d2ebf82f">close</a>()                          { }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;  enum_result <a class="code" href="classTC__LOG__DUMMY.html#acb87643d4017b6946c1f1814f8a4ca36">commit</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__DUMMY.html#af37509e3086560c3d057a0c43b67a238">rollback</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__DUMMY.html#a911680c1d0a8f4e5a028e2f1920ee2a2">prepare</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00154"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#a48cd538ebda31693671772018d2563b9">  154</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__DUMMY.html#a48cd538ebda31693671772018d2563b9">xlock</a>(<span class="keywordtype">void</span>) {}</div><div class="line"><a name="l00155"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#a0ac9df53eb4f1ec401e0bdf9d9c95f62">  155</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__DUMMY.html#a0ac9df53eb4f1ec401e0bdf9d9c95f62">xunlock</a>(<span class="keywordtype">void</span>) {}</div><div class="line"><a name="l00156"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#a144eb01c40fb75ae3a1c04609dc89ea3">  156</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__DUMMY.html#a144eb01c40fb75ae3a1c04609dc89ea3">slock</a>(<span class="keywordtype">void</span>) {}</div><div class="line"><a name="l00157"></a><span class="lineno"><a class="line" href="classTC__LOG__DUMMY.html#a5ab2da6fa3688756cf9694d25db67c6c">  157</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__DUMMY.html#a5ab2da6fa3688756cf9694d25db67c6c">sunlock</a>(<span class="keywordtype">void</span>) {}</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;};</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div><div class="line"><a name="l00160"></a><span class="lineno"><a class="line" href="classTC__LOG__MMAP.html">  160</a></span>&#160;<span class="keyword">class </span><a class="code" href="classTC__LOG__MMAP.html">TC_LOG_MMAP</a>: <span class="keyword">public</span> <a class="code" href="classTC__LOG.html">TC_LOG</a></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;{</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;<span class="keyword">public</span>:                <span class="comment">// only to keep Sun Forte on sol9x86 happy</span></div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">enum</span> {</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;    PS_POOL,                 <span class="comment">// page is in pool</span></div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    PS_ERROR,                <span class="comment">// last sync failed</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;    PS_DIRTY                 <span class="comment">// new xids added since last sync</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;  } PAGE_STATE;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;  <span class="keyword">typedef</span> <span class="keyword">struct </span>st_page {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    <span class="keyword">struct </span>st_page *next; <span class="comment">// pages are linked in a fifo queue</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;    my_xid *start, *end;  <span class="comment">// usable area of a page</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    my_xid *ptr;          <span class="comment">// next xid will be written here</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__MMAP.html#a242ceec9296d75dcfc09a9109ffa6a80">size</a>, free;       <span class="comment">// max and current number of free xid slots on the page</span></div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    <span class="keywordtype">int</span> waiters;          <span class="comment">// number of waiters on condition</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    PAGE_STATE state;     <span class="comment">// see above</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;<span class="comment"></span>    mysql_cond_t  cond;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  } PAGE;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;  <span class="keywordtype">char</span> logname[FN_REFLEN];</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  File fd;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;  my_off_t file_length;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  uint npages, inited;</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;  uchar *data;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;  <span class="keyword">struct </span>st_page *pages, *syncing, *active, *pool, **pool_last_ptr;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;  <span class="comment">/*</span></div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">    LOCK_tc is used to protect access both to data members &#39;syncing&#39;,</span></div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;<span class="comment">    &#39;active&#39;, &#39;pool&#39; and to the content of PAGE objects.</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;<span class="comment">  */</span></div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  mysql_mutex_t LOCK_tc;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;  mysql_cond_t COND_active;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;  mysql_cond_t COND_pool;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;<span class="keyword">public</span>:</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;  <a class="code" href="classTC__LOG__MMAP.html">TC_LOG_MMAP</a>(): inited(0) {}</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__MMAP.html#a2a7bf09548c80ed522a20ad9b9cff295">open</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *opt_name);</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__MMAP.html#aefc50f2b1eeb68743a1ab72219f85db4">close</a>();</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;  enum_result <a class="code" href="classTC__LOG__MMAP.html#ac8696930a9546b39057462eca51b3648">commit</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__MMAP.html#a5a050951b50e08417abbec375ab30614">rollback</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="classTC__LOG__MMAP.html#a334d9853acc2f7b12ae2a3014806f6c4">prepare</a>(<a class="code" href="namespaceTHD.html">THD</a> *thd, <span class="keywordtype">bool</span> all);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  <span class="keywordtype">int</span> recover();</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;  uint <a class="code" href="classTC__LOG__MMAP.html#a242ceec9296d75dcfc09a9109ffa6a80">size</a>() <span class="keyword">const</span>;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;</div><div class="line"><a name="l00217"></a><span class="lineno"><a class="line" href="classTC__LOG__MMAP.html#ab6e8fad0d9b8167b22d22f4372739202">  217</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__MMAP.html#ab6e8fad0d9b8167b22d22f4372739202">xlock</a>(<span class="keywordtype">void</span>) { mysql_rwlock_wrlock(&amp;LOCK_consistent_snapshot); }</div><div class="line"><a name="l00218"></a><span class="lineno"><a class="line" href="classTC__LOG__MMAP.html#a728d9b1b03c73850ba116b93677a42a8">  218</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__MMAP.html#a728d9b1b03c73850ba116b93677a42a8">xunlock</a>(<span class="keywordtype">void</span>) { mysql_rwlock_unlock(&amp;LOCK_consistent_snapshot); }</div><div class="line"><a name="l00219"></a><span class="lineno"><a class="line" href="classTC__LOG__MMAP.html#a8c90387699139f5e9d244e60c5a126a1">  219</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__MMAP.html#a8c90387699139f5e9d244e60c5a126a1">slock</a>(<span class="keywordtype">void</span>) { mysql_rwlock_rdlock(&amp;LOCK_consistent_snapshot); }</div><div class="line"><a name="l00220"></a><span class="lineno"><a class="line" href="classTC__LOG__MMAP.html#a8f2d68fb0873cc813dcfc65d4d922261">  220</a></span>&#160;  <span class="keywordtype">void</span> <a class="code" href="classTC__LOG__MMAP.html#a8f2d68fb0873cc813dcfc65d4d922261">sunlock</a>(<span class="keywordtype">void</span>) { mysql_rwlock_unlock(&amp;LOCK_consistent_snapshot); }</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;  ulong log_xid(my_xid xid);</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;  <span class="keywordtype">void</span> unlog(ulong cookie, my_xid xid);</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;  PAGE* get_active_from_pool();</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="keywordtype">bool</span> sync();</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordtype">void</span> overflow();</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;<span class="keyword">protected</span>:</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="comment">// We want to mock away syncing to disk in unit tests.</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="keyword">virtual</span> <span class="keywordtype">int</span> do_msync_and_fsync(<span class="keywordtype">int</span> fd_arg, <span class="keywordtype">void</span> *addr, <span class="keywordtype">size_t</span> len, <span class="keywordtype">int</span> flags)</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  {</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;    <span class="keywordflow">return</span> my_msync(fd_arg, addr, len, flags);</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  }</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;<span class="keyword">private</span>:</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  ulong store_xid_in_empty_slot(my_xid xid, PAGE *p, uchar *data_arg)</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;  {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;    <span class="comment">/* searching for an empty slot */</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;    <span class="keywordflow">while</span> (*p-&gt;ptr)</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;    {</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;      p-&gt;ptr++;</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;      DBUG_ASSERT(p-&gt;ptr &lt; p-&gt;end);               <span class="comment">// because p-&gt;free &gt; 0</span></div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;    }</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;    <span class="comment">/* found! store xid there and mark the page dirty */</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    ulong cookie= (ulong)((uchar *)p-&gt;ptr - data_arg);      <span class="comment">// can never be zero</span></div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    *p-&gt;ptr++= xid;</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;    p-&gt;free--;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;    p-&gt;state= PS_DIRTY;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;    <span class="keywordflow">return</span> cookie;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  }</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;  <span class="keywordtype">bool</span> wait_sync_completion(PAGE *p)</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;  {</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;    p-&gt;waiters++;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">while</span> (p-&gt;state == PS_DIRTY &amp;&amp; syncing)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    {</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      mysql_cond_wait(&amp;p-&gt;cond, &amp;LOCK_tc);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    }</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    p-&gt;waiters--;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    <span class="keywordflow">return</span> p-&gt;state == PS_ERROR;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;  }</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  <span class="comment">/*</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">    the following friend declaration is to grant access from TCLogMMapTest</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">    to methods log_xid()/unlog() that are private.</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;<span class="comment">  */</span></div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;  <span class="keyword">friend</span> <span class="keyword">class </span>TCLogMMapTest;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;};</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;<span class="keyword">extern</span> <a class="code" href="classTC__LOG.html">TC_LOG</a> *tc_log;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;<span class="keyword">extern</span> <a class="code" href="classTC__LOG__MMAP.html">TC_LOG_MMAP</a> tc_log_mmap;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;<span class="keyword">extern</span> <a class="code" href="classTC__LOG__DUMMY.html">TC_LOG_DUMMY</a> tc_log_dummy;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="preprocessor">#endif // TC_LOG_H</span></div><div class="ttc" id="classTC__LOG__MMAP_html_ac8696930a9546b39057462eca51b3648"><div class="ttname"><a href="classTC__LOG__MMAP.html#ac8696930a9546b39057462eca51b3648">TC_LOG_MMAP::commit</a></div><div class="ttdeci">enum_result commit(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:286</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_ac5c9f424a1544aafc9fe08e894bbce81"><div class="ttname"><a href="classTC__LOG__DUMMY.html#ac5c9f424a1544aafc9fe08e894bbce81">TC_LOG_DUMMY::open</a></div><div class="ttdeci">int open(const char *opt_name)</div><div class="ttdef"><b>Definition:</b> tc_log.h:149</div></div>
<div class="ttc" id="classTC__LOG_html"><div class="ttname"><a href="classTC__LOG.html">TC_LOG</a></div><div class="ttdef"><b>Definition:</b> tc_log.h:40</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_af37509e3086560c3d057a0c43b67a238"><div class="ttname"><a href="classTC__LOG__DUMMY.html#af37509e3086560c3d057a0c43b67a238">TC_LOG_DUMMY::rollback</a></div><div class="ttdeci">int rollback(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:34</div></div>
<div class="ttc" id="classTC__LOG_html_abf637f1bbf02c6f8e4f69aa2f5e2d362"><div class="ttname"><a href="classTC__LOG.html#abf637f1bbf02c6f8e4f69aa2f5e2d362">TC_LOG::rollback</a></div><div class="ttdeci">virtual int rollback(THD *thd, bool all)=0</div></div>
<div class="ttc" id="classTC__LOG_html_a5b73af1ad12c691b3417c565f7e58a1c"><div class="ttname"><a href="classTC__LOG.html#a5b73af1ad12c691b3417c565f7e58a1c">TC_LOG::slock</a></div><div class="ttdeci">virtual void slock(void)=0</div></div>
<div class="ttc" id="classTC__LOG_html_ab968f1e200f370127c3dcd0302d00968"><div class="ttname"><a href="classTC__LOG.html#ab968f1e200f370127c3dcd0302d00968">TC_LOG::prepare</a></div><div class="ttdeci">virtual int prepare(THD *thd, bool all)=0</div></div>
<div class="ttc" id="classTC__LOG_html_a3f9ef43db745a798f8b361eb0b93ff22"><div class="ttname"><a href="classTC__LOG.html#a3f9ef43db745a798f8b361eb0b93ff22">TC_LOG::commit</a></div><div class="ttdeci">virtual enum_result commit(THD *thd, bool all)=0</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_a5ab2da6fa3688756cf9694d25db67c6c"><div class="ttname"><a href="classTC__LOG__DUMMY.html#a5ab2da6fa3688756cf9694d25db67c6c">TC_LOG_DUMMY::sunlock</a></div><div class="ttdeci">void sunlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:157</div></div>
<div class="ttc" id="classTC__LOG_html_ab383cdb4b722c9b11d284ac8b970b087"><div class="ttname"><a href="classTC__LOG.html#ab383cdb4b722c9b11d284ac8b970b087">TC_LOG::sunlock</a></div><div class="ttdeci">virtual void sunlock(void)=0</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a5a050951b50e08417abbec375ab30614"><div class="ttname"><a href="classTC__LOG__MMAP.html#a5a050951b50e08417abbec375ab30614">TC_LOG_MMAP::rollback</a></div><div class="ttdeci">int rollback(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:315</div></div>
<div class="ttc" id="classTC__LOG_html_a57d3ed9dfb015fb2427a25eecaf78687"><div class="ttname"><a href="classTC__LOG.html#a57d3ed9dfb015fb2427a25eecaf78687">TC_LOG::using_heuristic_recover</a></div><div class="ttdeci">bool using_heuristic_recover()</div><div class="ttdef"><b>Definition:</b> tc_log.cc:561</div></div>
<div class="ttc" id="classTC__LOG_html_a60ee380273adc9e23c56ff114cd2636a"><div class="ttname"><a href="classTC__LOG.html#a60ee380273adc9e23c56ff114cd2636a">TC_LOG::xunlock</a></div><div class="ttdeci">virtual void xunlock(void)=0</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_a911680c1d0a8f4e5a028e2f1920ee2a2"><div class="ttname"><a href="classTC__LOG__DUMMY.html#a911680c1d0a8f4e5a028e2f1920ee2a2">TC_LOG_DUMMY::prepare</a></div><div class="ttdeci">int prepare(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:40</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_aefc50f2b1eeb68743a1ab72219f85db4"><div class="ttname"><a href="classTC__LOG__MMAP.html#aefc50f2b1eeb68743a1ab72219f85db4">TC_LOG_MMAP::close</a></div><div class="ttdeci">void close()</div><div class="ttdef"><b>Definition:</b> tc_log.cc:471</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a334d9853acc2f7b12ae2a3014806f6c4"><div class="ttname"><a href="classTC__LOG__MMAP.html#a334d9853acc2f7b12ae2a3014806f6c4">TC_LOG_MMAP::prepare</a></div><div class="ttdeci">int prepare(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:321</div></div>
<div class="ttc" id="namespaceTHD_html"><div class="ttname"><a href="namespaceTHD.html">THD</a></div></div>
<div class="ttc" id="classTC__LOG_html_a645b5d1b49c4c4396d327eef07e2dd53"><div class="ttname"><a href="classTC__LOG.html#a645b5d1b49c4c4396d327eef07e2dd53">TC_LOG::close</a></div><div class="ttdeci">virtual void close()=0</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_a0ac9df53eb4f1ec401e0bdf9d9c95f62"><div class="ttname"><a href="classTC__LOG__DUMMY.html#a0ac9df53eb4f1ec401e0bdf9d9c95f62">TC_LOG_DUMMY::xunlock</a></div><div class="ttdeci">void xunlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:155</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a2a7bf09548c80ed522a20ad9b9cff295"><div class="ttname"><a href="classTC__LOG__MMAP.html#a2a7bf09548c80ed522a20ad9b9cff295">TC_LOG_MMAP::open</a></div><div class="ttdeci">int open(const char *opt_name)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:92</div></div>
<div class="ttc" id="classTC__LOG_html_aac75dc061e9aae27449e675b23c27ae3"><div class="ttname"><a href="classTC__LOG.html#aac75dc061e9aae27449e675b23c27ae3">TC_LOG::xlock</a></div><div class="ttdeci">virtual void xlock(void)=0</div></div>
<div class="ttc" id="classTC__LOG_html_a34eb4c35fe8d29b0febbd700a61b282d"><div class="ttname"><a href="classTC__LOG.html#a34eb4c35fe8d29b0febbd700a61b282d">TC_LOG::open</a></div><div class="ttdeci">virtual int open(const char *opt_name)=0</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a242ceec9296d75dcfc09a9109ffa6a80"><div class="ttname"><a href="classTC__LOG__MMAP.html#a242ceec9296d75dcfc09a9109ffa6a80">TC_LOG_MMAP::size</a></div><div class="ttdeci">uint size() const</div><div class="ttdef"><b>Definition:</b> tc_log.cc:197</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_adb7792f21f5a090a7d71a646d2ebf82f"><div class="ttname"><a href="classTC__LOG__DUMMY.html#adb7792f21f5a090a7d71a646d2ebf82f">TC_LOG_DUMMY::close</a></div><div class="ttdeci">void close()</div><div class="ttdef"><b>Definition:</b> tc_log.h:150</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_a144eb01c40fb75ae3a1c04609dc89ea3"><div class="ttname"><a href="classTC__LOG__DUMMY.html#a144eb01c40fb75ae3a1c04609dc89ea3">TC_LOG_DUMMY::slock</a></div><div class="ttdeci">void slock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:156</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a8c90387699139f5e9d244e60c5a126a1"><div class="ttname"><a href="classTC__LOG__MMAP.html#a8c90387699139f5e9d244e60c5a126a1">TC_LOG_MMAP::slock</a></div><div class="ttdeci">void slock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:219</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a8f2d68fb0873cc813dcfc65d4d922261"><div class="ttname"><a href="classTC__LOG__MMAP.html#a8f2d68fb0873cc813dcfc65d4d922261">TC_LOG_MMAP::sunlock</a></div><div class="ttdeci">void sunlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:220</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_a728d9b1b03c73850ba116b93677a42a8"><div class="ttname"><a href="classTC__LOG__MMAP.html#a728d9b1b03c73850ba116b93677a42a8">TC_LOG_MMAP::xunlock</a></div><div class="ttdeci">void xunlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:218</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html_ab6e8fad0d9b8167b22d22f4372739202"><div class="ttname"><a href="classTC__LOG__MMAP.html#ab6e8fad0d9b8167b22d22f4372739202">TC_LOG_MMAP::xlock</a></div><div class="ttdeci">void xlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:217</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_acb87643d4017b6946c1f1814f8a4ca36"><div class="ttname"><a href="classTC__LOG__DUMMY.html#acb87643d4017b6946c1f1814f8a4ca36">TC_LOG_DUMMY::commit</a></div><div class="ttdeci">enum_result commit(THD *thd, bool all)</div><div class="ttdef"><b>Definition:</b> tc_log.cc:28</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html_a48cd538ebda31693671772018d2563b9"><div class="ttname"><a href="classTC__LOG__DUMMY.html#a48cd538ebda31693671772018d2563b9">TC_LOG_DUMMY::xlock</a></div><div class="ttdeci">void xlock(void)</div><div class="ttdef"><b>Definition:</b> tc_log.h:154</div></div>
<div class="ttc" id="classTC__LOG__DUMMY_html"><div class="ttname"><a href="classTC__LOG__DUMMY.html">TC_LOG_DUMMY</a></div><div class="ttdef"><b>Definition:</b> tc_log.h:145</div></div>
<div class="ttc" id="classTC__LOG__MMAP_html"><div class="ttname"><a href="classTC__LOG__MMAP.html">TC_LOG_MMAP</a></div><div class="ttdef"><b>Definition:</b> tc_log.h:160</div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.15
</small></address>
</body>
</html>
